<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>× ×™×”×•×œ ×¤×™× × ×¡×™</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root {
  --bg: #faf8ff;
  --card: #ffffff;
  --text: #1a1333;
  --muted: #6b628f;
  --primary: #6f42c1;
  --primary-weak: #efe9ff;
  --accent: #00a389;
  --danger: #cc3b3b;
  --ok: #2fa85a;
  --border: #e8e3f7;
  --table-stripe: #fbfaff;
  --shadow: 0 2px 12px rgba(50, 30, 120, 0.08);
  --radius: 14px;
  --font: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans Hebrew", "Noto Sans";
}

body.theme-dark {
  --bg: #0f0e14;
  --card: #171625;
  --text: #f1edff;
  --muted: #a39dbf;
  --primary: #a98eda;
  --primary-weak: #261f3f;
  --accent: #28c1aa;
  --danger: #ff6b6b;
  --ok: #4bd37a;
  --border: #2b2741;
  --table-stripe: #1a1930;
  --shadow: 0 2px 14px rgba(0,0,0,0.35);
}
body.theme-blue { --primary:#2f6ce5; --primary-weak:#e7f0ff; --accent:#00a6fb; }
body.theme-rose { --primary:#d9487d; --primary-weak:#ffe7f0; --accent:#ff7a90; }

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: var(--font);
  margin: 0;
}

* { box-sizing: border-box; }

header {
  position: sticky; top: 0; z-index: 50;
  background: linear-gradient(180deg, var(--card), color-mix(in srgb, var(--card) 70%, transparent));
  border-bottom: 1px solid var(--border);
  box-shadow: var(--shadow);
  backdrop-filter: blur(10px);
}
.container { max-width: 1100px; margin: 0 auto; padding: 12px; }
.topbar { display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; }
.app-title { font-size: 20px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; }
.month-picker { display: flex; align-items: center; gap: 6px; }

select, input[type="number"], input[type="text"], input[type="month"] {
  background: var(--card); color: var(--text);
  border: 1px solid var(--border); border-radius: 10px;
  padding: 8px 10px; width: 100%;
  transition: all 0.2s;
}
select:focus, input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px var(--primary-weak);
}
button {
  border: none; background: var(--primary); color: #fff;
  padding: 9px 14px; border-radius: 999px;
  cursor: pointer; font-weight: 600; transition: all 0.2s;
}
button:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
button:active { transform: translateY(0); }
button.ghost { background: var(--primary-weak); color: var(--primary); }
button.ok { background: var(--ok); }
button.danger { background: var(--danger); }
button.small { padding: 5px 10px; font-size: 13px; }

.tabs { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
.tab-btn { background: var(--primary-weak); color: var(--primary); padding: 6px 12px; }
.tab-btn.active { background: var(--primary); color: #fff; }
.tab { display: none; padding: 16px 0 80px; } /* ×¨×™×•×•×— ×ª×—×ª×•×Ÿ × ×•×¡×£ */
.tab.active { display: block; animation: fadeIn 0.3s; }

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin: 14px 0 8px; }
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 14px;
  transition: all 0.2s;
}
.card:hover { box-shadow: 0 4px 20px rgba(50, 30, 120, 0.12); }
.stat { font-size: 14px; color: var(--muted); }
.stat strong { display: block; font-size: 22px; color: var(--text); margin-top: 6px; }
.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--border);
  border-radius: 999px;
  overflow: hidden;
  margin-top: 8px;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--ok), var(--accent));
  transition: width 0.3s;
}

table {
  width: 100%; border-collapse: collapse; border-radius: 12px;
  background: var(--card); border: 1px solid var(--border);
  overflow: hidden;
}
thead th {
  background: var(--primary-weak);
  color: var(--primary);
  padding: 10px;
  text-align: right;
  font-size: 14px;
  position: sticky;
  top: 0;
  z-index: 10;
}
tbody td { border-bottom: 1px solid var(--border); padding: 8px 10px; font-size: 14px; }
tbody tr:nth-child(even) td { background: var(--table-stripe); }
tbody tr:hover td { background: var(--primary-weak); }
.num { text-align: left; font-variant-numeric: tabular-nums; }

.section-title {
  margin: 18px 6px 10px;
  font-weight: 800; color: var(--muted); font-size: 15px;
  display: flex; align-items: center; gap: 8px;
}
.toolbar { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.grid2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }

@media (max-width: 900px){
  .cards { grid-template-columns: 1fr; }
  .grid2 { grid-template-columns: 1fr; }
  .topbar { grid-template-columns: 1fr; gap: 8px; }
}
@media (max-width: 600px){
  .app-title { font-size: 18px; text-align: center; }
  .tabs { justify-content: center; }
  .tab-btn { flex: 1; text-align: center; font-size: 14px; }
  .cards { grid-template-columns: 1fr; }
  .stat strong { font-size: 18px; }
  input, select, button { font-size: 14px; padding: 10px; }
  table { font-size: 13px; }
  thead th, tbody td { padding: 6px; }
  .toolbar { flex-direction: column; gap: 6px; }
}

.pct-green { color: var(--ok); font-weight: 600; }
.pct-yellow { color: orange; font-weight: 600; }
.pct-red { color: var(--danger); font-weight: 600; }

.settings-panel {
  position: fixed;
  top: 0; right: -100%;
  width: 100%; max-width: 420px; height: 100%;
  background: var(--card); color: var(--text);
  box-shadow: -2px 0 10px rgba(0,0,0,0.3);
  z-index: 999; transition: right 0.3s ease-in-out;
  display: flex; flex-direction: column;
}
.settings-panel.active { right: 0; }
.settings-panel header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 14px; border-bottom: 1px solid var(--border); background: var(--primary-weak);
}
.settings-panel header h3 { margin: 0; font-size: 18px; color: var(--primary); }
.settings-panel header button {
  background: none; border: none; font-size: 20px; cursor: pointer; color: var(--primary);
}
.settings-panel .content { flex: 1; overflow-y: auto; padding: 14px; }
.settings-row { margin: 12px 0; }
.settings-row label { display: block; margin: 8px 0; cursor: pointer; }

.badge {
  display: inline-block;
  padding: 4px 10px; border-radius: 999px;
  font-size: 12px; font-weight: 600;
  background: var(--primary-weak); color: var(--primary);
}
.badge.success { background: #e8f5e9; color: var(--ok); }
.badge.danger { background: #ffebee; color: var(--danger); }

.icon-btn {
  width: 32px; height: 32px; padding: 0;
  display: inline-flex; align-items: center; justify-content: center;
  border-radius: 8px;
}
.delete-btn {
  background: transparent; color: var(--danger);
  border: 1px solid var(--danger); padding: 4px 8px; font-size: 12px;
}
.delete-btn:hover { background: var(--danger); color: white; }

.modal-overlay {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5); z-index: 998; display: none; cursor: pointer;
}
.modal-overlay.active { display: block; }

/* ========== ×™×¢×“ ×—×™×¡×›×•×Ÿ ========== */
.goal-container {
  max-width: 800px;
  margin: 0 auto;
  color: var(--text);
  font-family: var(--font);
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin-bottom: 20px;
}
.stat-card {
  background: var(--card);
  border-radius: 12px;
  padding: 15px;
  text-align: center;
  box-shadow: var(--shadow);
}
.stat-card .value {
  font-size: 1.5em;
  font-weight: bold;
  color: var(--primary);
}
.target-section {
  background: var(--card);
  border-radius: 12px;
  padding: 15px;
  margin: 15px 0;
  box-shadow: var(--shadow);
}
.target-section label {
  display: block;
  font-weight: bold;
  margin-bottom: 8px;
  color: var(--primary);
}
.saving-card {
  background: var(--card);
  border-radius: 15px;
  margin: 15px 0;
  box-shadow: var(--shadow);
  overflow: hidden;
  transition: all 0.3s ease;
}
.saving-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, var(--primary-weak) 0%, var(--border) 100%);
  padding: 15px;
  cursor: pointer;
}
.saving-header h2 {
  margin: 0;
  font-size: 1.2em;
  color: var(--primary);
}
.saving-body {
  display: none;
  padding: 20px;
  border-top: 2px solid var(--primary-weak);
}
.saving-body.open { display: block; }
.progress {
  background: var(--primary-weak);
  border-radius: 10px;
  height: 12px;
  overflow: hidden;
  margin-top: 10px;
}
.saving-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #667eea, #764ba2);
  width: 0%;
  transition: width 0.8s;
}
.copy-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 8px 15px;
  margin-top: 10px;
}

/* ×’×¨×£ ×™×¢×“ ×—×™×¡×›×•×Ÿ */
#goalBar {
  width: 100%;
  height: 250px;
  margin-top: 15px;
}

/* ×”×ª×××•×ª ××•×‘×™×™×œ ×œ×™×¢×“ ×—×™×¡×›×•×Ÿ */
@media (max-width: 600px) {
  .goal-container { padding: 0 10px; }
  .stat-card h3 { font-size: 14px; }
  .stat-card .value { font-size: 1.2em; }
  .saving-card h2 { font-size: 1em; }
  .saving-body { padding: 15px; }
}
.bottom-nav {
  position: fixed;
  bottom: 0; right: 0; left: 0;
  background: var(--card);
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 8px 0;
  z-index: 100;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
}

.nav-btn {
  background: none;
  border: none;
  color: var(--muted);
  font-size: 13px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  cursor: pointer;
}

.nav-btn.active {
  color: var(--primary);
  font-weight: 700;
}
.nav-btn span {
  font-size: 12px;
}

#btnOpenPanel.fixed-settings {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 1000;
  background: var(--primary);
  color: #fff;
  border-radius: 50%;
  width: 44px;
  height: 44px;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow);
  transition: background 0.2s, transform 0.2s;
}
#btnOpenPanel.fixed-settings:hover {
  background: var(--accent);
  transform: scale(1.05);
}
.delete-btn {
  display: none !important;
}
</style>
</head>
<body>
  <button id="btnOpenPanel" class="fixed-settings">âš™ï¸</button>
  <div class="modal-overlay" id="modalOverlay"></div>

  <header>
    <div class="container">
      <div class="topbar">
        <div class="app-title">
          <span>ğŸ’°</span>
          × ×™×”×•×œ ×¤×™× × ×¡×™
        </div>
        <div class="month-picker">
          <button class="icon-btn ghost" id="prevMonth">â—€</button>
          <input type="month" id="monthInput" />
          <button class="icon-btn ghost" id="nextMonth">â–¶</button>
        </div>
        <div>

        </div>
      </div>

    </div>
  </header>

  <main class="container">
    <!-- TAB: MONTH -->
    <section id="tab-month" class="tab active">
      <div class="cards" id="summaryCards">
        <div class="card">
          <div class="stat">ğŸ’µ ×”×›× ×¡×•×ª ×¡×”×´×›</div>
          <strong id="sumIncome">â‚ª0</strong>
          <div class="progress-bar">
            <div class="progress-fill" id="incomeProgress" style="width: 0%"></div>
          </div>
        </div>

        <div class="card">
          <div class="stat">ğŸ’¸ ×”×•×¦××•×ª ×¡×”×´×›</div>
          <strong id="sumExpense">â‚ª0</strong>
          <div class="progress-bar">
            <div class="progress-fill" id="expenseProgress" style="width: 0%"></div>
          </div>
        </div>

        <div class="card">
          <div class="stat">ğŸ’ ×—×™×¡×›×•×Ÿ × ×˜×•</div>
          <strong id="sumNet">â‚ª0</strong>
          <span class="badge" id="savingBadge"></span>
        </div>
      </div>

      <h3 class="section-title">ğŸ“‰ ×”×•×¦××•×ª</h3>
      <div class="toolbar">
        <button id="addExpenseRow" class="ghost small">â• ×”×•×¡×¤×ª ×§×˜×’×•×¨×™×”</button>
      </div>
      <table id="expenseTable">
        <thead>
          <tr>
            <th>×§×˜×’×•×¨×™×”</th>
            <th>×¦×¤×™</th>
            <th>×‘×¤×•×¢×œ</th>
            <th>×”×¤×¨×©</th>
            <th>××—×•×–</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3 class="section-title">ğŸ“ˆ ×”×›× ×¡×•×ª</h3>
      <div class="toolbar">
        <button id="addIncomeRow" class="ghost small">â• ×”×•×¡×¤×ª ××§×•×¨</button>
      </div>
      <table id="incomeTable">
        <thead>
          <tr>
            <th>××§×•×¨</th>
            <th>×¦×¤×™</th>
            <th>×‘×¤×•×¢×œ</th>
            <th>×”×¤×¨×©</th>
            <th>××—×•×–</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- TAB: GOAL -->
    <section id="tab-goal" class="tab">
      <div class="goal-container">
        <h1>ğŸ’° × ×™×”×•×œ ×™×¢×“ ×—×™×¡×›×•×Ÿ</h1>

        <div class="stats-grid">
          <div class="stat-card">
            <h3>×¡×”"×› × ×•×›×—×™</h3>
            <div class="value" id="currentTotal">0 â‚ª</div>
          </div>
          <div class="stat-card">
            <h3>×—×™×¡×›×•× ×•×ª ×¤×¢×™×œ×™×</h3>
            <div class="value" id="savingsCount">0</div>
          </div>
        </div>

        <div class="target-section">
          <label><span class="icon">ğŸ¯</span> ×ª××¨×™×š ×™×¢×“:</label>
          <input type="date" id="targetDate" onchange="calculateForecast()">
          <button onclick="calculateForecast()" style="width: 100%; margin-top: 10px;">
            ğŸ“Š ×—×©×‘ ×ª×—×–×™×ª ××œ××”
          </button>
        </div>

        <div id="savingsContainer"></div>

        <div id="controls">
          <button onclick="addSaving()">â• ×”×•×¡×£ ×—×™×¡×›×•×Ÿ ×—×“×©</button>
        </div>

        <!-- ×’×¨×£ ×™×¢×“ ×—×™×¡×›×•×Ÿ -->
      </div>

      <div id="total">
        <div class="total-content">
          <div class="total-label">×ª×—×–×™×ª ×œ×ª××¨×™×š ×”×™×¢×“</div>
          <div class="total-amount" id="totalAmount">0 â‚ª</div>
        </div>
      </div>
    </section>

â€<!-- TAB: YEARLY (×¦×¤×™ ×©× ×ª×™) -->
â€<section id="tab-year" class="tab">
â€  <div class="container">
â€    <h2 class="section-title">ğŸ“… ××‘×˜ ×©× ×ª×™ â€” ×¦×¤×™ ××•×œ ×‘×™×¦×•×¢</h2>

â€    <div class="cards">
â€      <div class="card">
â€        <div class="stat">ğŸ’µ ×”×›× ×¡×•×ª</div>
â€        <strong id="yearInc">â€”</strong>
â€        <div class="progress-bar">
â€          <div id="yearIncFill" class="progress-fill" style="width:0%"></div>
â€        </div>
â€        <div class="stat subtle" id="yearIncText"></div>
â€      </div>

â€      <div class="card">
â€        <div class="stat">ğŸ’¸ ×”×•×¦××•×ª</div>
â€        <strong id="yearExp">â€”</strong>
â€        <div class="progress-bar">
â€          <div id="yearExpFill" class="progress-fill" style="width:0%"></div>
â€        </div>
â€        <div class="stat subtle" id="yearExpText"></div>
â€      </div>

â€      <div class="card">
â€        <div class="stat">ğŸ’ ×—×™×¡×›×•×Ÿ</div>
â€        <strong id="yearSav">â€”</strong>
â€        <div class="progress-bar">
â€          <div id="yearSavFill" class="progress-fill" style="width:0%"></div>
â€        </div>
â€        <div class="stat subtle" id="yearSavText"></div>
â€      </div>
â€    </div>

â€    <div class="summary-text" id="yearSummaryLine">â€”</div>

â€    <h3 class="section-title" style="margin-top:20px;">ğŸ“‚ ×¤×™×¨×•×˜ ×§×˜×’×•×¨×™×•×ª â€” ×¢×“ ×”×—×•×“×© ×”×–×”</h3>
â€    <div class="table-wrapper" style="overflow-x:auto;">
â€      <table class="table" id="yearCatTable">
â€        <thead>
â€          <tr>
â€            <th>×§×˜×’×•×¨×™×”</th>
â€            <th>×¦×¤×™ YTD</th>
â€            <th>×‘×¤×•×¢×œ YTD</th>
â€            <th>×¡×˜×™×™×”</th>
â€            <th class="num">× ×™×¦×•×œ %</th>
â€          </tr>
â€        </thead>
â€        <tbody></tbody>
â€      </table>
â€    </div>

â€    <div class="footer-note">× ×™×¦×•×œ â‰¤ 100% = ×˜×•×‘ â€¢ × ×ª×•× ×™ ×××ª ×œ×¤×™ ×”×§×˜×’×•×¨×™×•×ª ×”×—×•×“×©×™×•×ª ×©×œ×š</div>
â€  </div>
â€</section>
  </main>
<nav class="bottom-nav">
  <button class="nav-btn active" data-tab="tab-month">ğŸ <span>×—×•×“×©</span></button>
  <button class="nav-btn" data-tab="tab-goal">ğŸ’µ<span>×—×¡×›×•× ×•×ª</span></button>
â€<button class="nav-btn" data-tab="tab-year">ğŸ“…<span>×©× ×ª×™</span></button>
</nav>
  <!-- SETTINGS PANEL -->
  <div class="settings-panel" id="settingsPanel">
    <header>
      <h3>âš™ï¸ ×”×’×“×¨×•×ª</h3>
      <button id="btnClosePanel">âœ–</button>
    </header>
    <div class="content">
      <h4>ğŸ¨ ×¢×¨×›×ª ×¦×‘×¢×™×</h4>
      <label><input type="radio" name="theme" value="default" checked> ×¡×’×œ×’×œ-×‘×”×™×¨</label><br>
      <label><input type="radio" name="theme" value="theme-dark"> ×›×”×”</label><br>
      <label><input type="radio" name="theme" value="theme-blue"> ×›×—×•×œ×”</label><br>
      <label><input type="radio" name="theme" value="theme-rose"> ×•×¨×•×“×”</label><br>

      <h4>âœï¸ ×’×•×¤×Ÿ</h4>
      <label><input type="radio" name="font" value="system" checked> ××¢×¨×›×ª</label><br>
      <label><input type="radio" name="font" value="alef"> Alef</label><br>
      <label><input type="radio" name="font" value="assistant"> Assistant</label><br>

      <h3 style="margin-top:20px">ğŸ·ï¸ × ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</h3>

      <h4>×”×•×¦××•×ª</h4>
      <table id="manageExp">
        <thead>
          <tr><th>×©×</th><th>×¦×¤×™ ×‘×¨×™×¨×ª ××—×“×œ</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="toolbar"><button id="addExpCat" class="ghost small">â• ×”×•×¡×£ ×§×˜×’×•×¨×™×”</button></div>

      <h4>×”×›× ×¡×•×ª</h4>
      <table id="manageInc">
        <thead>
          <tr><th>×©×</th><th>×¦×¤×™ ×‘×¨×™×¨×ª ××—×“×œ</th><th></th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="toolbar"><button id="addIncCat" class="ghost small">â• ×”×•×¡×£ ××§×•×¨</button></div>

      <div class="toolbar" style="margin-top:12px">
        <button id="saveCats" class="ok">ğŸ’¾ ×©××•×¨ ×§×˜×’×•×¨×™×•×ª</button>
      </div>

      <hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">

      <div class="toolbar">
        <button id="resetAll" class="danger">ğŸ—‘ï¸ ××™×¤×•×¡ ×›×œ ×”× ×ª×•× ×™×</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   UTILITIES & STORAGE
   ========================= */
const LS_KEY = 'moneyApp_v2';
const currency = 'â‚ª';

/* Format number to currency */
function fmt(n) {
  if (n === '' || n === null || isNaN(n)) return '';
  return currency + Number(n).toLocaleString('he-IL', { maximumFractionDigits: 2 });
}

/* Parse numeric input safely */
function parseNum(v) {
  if (v === '' || v === null || v === undefined) return '';
  if (typeof v === 'string') v = v.replace(',', '.').trim();
  const n = Number(v);
  return isNaN(n) ? '' : n;
}

/* Year-Month string */
function ymStr(d) { return d.toISOString().slice(0, 7); }

/* Get state from localStorage */
function getState() {
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch (e) { return null; }
}

/* Save state to localStorage */
function saveState(state) {
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}

/* Ensure state exists */
function ensureState() {
  let s = getState();
  if (!s) {
    s = {
      theme: 'default',
      font: 'system',
      months: {},
      defaults: {
        expenses: [
          { name: '×©×›×™×¨×•×ª', plan: 1200 },
          { name: '×¡×•×¤×¨', plan: 1000 },
          { name: '×‘×’×“×™×', plan: 500 },
          { name: '××•×›×œ ×‘×—×•×¥', plan: 500 },
          { name: '×§×•×¡××˜×™×§×”', plan: 120 },
          { name: '×§×‘×•×¢', plan: 155 },
          { name: '×©×•× ×•×ª', plan: 200 },
          { name: '×ª×—×‘×•×¨×”', plan: 200 },
          { name: '×“×‘×¨×™× ×œ×‘×™×ª', plan: 500 },
        ],
        incomes: [
          { name: '×¢×‘×•×“×”', plan: 11827 },
          { name: '×©×™×¢×•×¨×™× ×¤×¨×˜×™×™×', plan: 200 },
          { name: '××™× ×¡×˜×’×¨×', plan: 200 },
          { name: '×¤×™×™×¡×‘×•×§', plan: 200 },
        ]
      },
      goal: {
        amount: 60000,
        from: new Date(new Date().getFullYear(), 0, 1).toISOString().slice(0, 7),
        to: new Date(new Date().getFullYear(), 11, 1).toISOString().slice(0, 7)
      }
    };
    saveState(s);
  }
  return s;
}

/* =========================
   GLOBAL STATE
   ========================= */
let state = ensureState();
let currentYM = ymStr(new Date());

/* =========================
   MONTH INITIALIZATION
   ========================= */
function ensureMonth(yymm) {
  if (!state.months[yymm]) {
    state.months[yymm] = {
      expenses: state.defaults.expenses.map(e => ({ name: e.name, plan: e.plan ?? '', actual: '' })),
      incomes: state.defaults.incomes.map(i => ({ name: i.name, plan: i.plan ?? '', actual: '' }))
    };
    saveState(state);
  }
  return state.months[yymm];
}

/* =========================
   DOM REFERENCES
   ========================= */
const monthInput = document.getElementById('monthInput');
const prevMonth = document.getElementById('prevMonth');
const nextMonth = document.getElementById('nextMonth');
const tabsBtns = Array.from(document.querySelectorAll('.tab-btn'));
const tabs = Array.from(document.querySelectorAll('.tab'));

const expTBody = document.querySelector('#expenseTable tbody');
const incTBody = document.querySelector('#incomeTable tbody');

const sumIncomeEl = document.getElementById('sumIncome');
const sumExpenseEl = document.getElementById('sumExpense');
const sumNetEl = document.getElementById('sumNet');
const savingBadge = document.getElementById('savingBadge');
const incomeProgress = document.getElementById('incomeProgress');
const expenseProgress = document.getElementById('expenseProgress');

const btnAddExp = document.getElementById('addExpenseRow');
const btnAddInc = document.getElementById('addIncomeRow');

const goalAmount = document.getElementById('goalAmount');
const goalFrom = document.getElementById('goalFrom');
const goalTo = document.getElementById('goalTo');
const goalMonthly = document.getElementById('goalMonthly');
const goalMsg = document.getElementById('goalMsg');
const saveGoal = document.getElementById('saveGoal');

const forecastTo = document.getElementById('forecastTo');
const runForecast = document.getElementById('runForecast');
const forecastSummary = document.getElementById('forecastSummary');

const settingsPanel = document.getElementById('settingsPanel');
const modalOverlay = document.getElementById('modalOverlay');
const btnClosePanel = document.getElementById('btnClosePanel');
const resetAll = document.getElementById('resetAll');
const saveCats = document.getElementById('saveCats');
const manageExpTBody = document.querySelector('#manageExp tbody');
const manageIncTBody = document.querySelector('#manageInc tbody');
const addExpCat = document.getElementById('addExpCat');
const addIncCat = document.getElementById('addIncCat');

/* =========================
   TABS NAVIGATION
   ========================= */
tabsBtns.forEach(b => {
  b.addEventListener('click', () => {
    tabsBtns.forEach(x => x.classList.remove('active'));
    tabs.forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    document.getElementById(b.dataset.tab).classList.add('active');

    if (b.dataset.tab === 'tab-reports') renderTrends();
  });
});

/* =========================
   MONTH PICKER
   ========================= */
function initMonthPicker() {
  monthInput.value = currentYM;

  monthInput.addEventListener('change', () => {
    currentYM = monthInput.value || ymStr(new Date());
    ensureMonth(currentYM);
    renderTables();
    renderSummary();
  });

  prevMonth.addEventListener('click', () => {
    const d = new Date(currentYM + '-01');
    d.setMonth(d.getMonth() - 1);
    currentYM = ymStr(d);
    monthInput.value = currentYM;
    ensureMonth(currentYM);
    renderTables();
    renderSummary();
  });

  nextMonth.addEventListener('click', () => {
    const d = new Date(currentYM + '-01');
    d.setMonth(d.getMonth() + 1);
    currentYM = ymStr(d);
    monthInput.value = currentYM;
    ensureMonth(currentYM);
    renderTables();
    renderSummary();
  });
}
  /* =========================
     RENDER TABLES & ROWS
     ========================= */
  function makeRow(type, idx, row) {
    const tr = document.createElement('tr');

    // ×©×
    const tdName = document.createElement('td');
    const inpName = document.createElement('input');
    inpName.type = 'text';
    inpName.value = row.name || '';
    inpName.addEventListener('input', () => {
      row.name = inpName.value;
      saveState(state);
    });
    tdName.appendChild(inpName);

    // ×¦×¤×™
    const tdPlan = document.createElement('td');
    const inpPlan = document.createElement('input');
    inpPlan.type = 'number'; inpPlan.min = '0'; inpPlan.step = '0.01';
    inpPlan.value = row.plan !== '' ? row.plan : '';
    inpPlan.addEventListener('change', () => {
      const old = row.plan;
      const newVal = parseNum(inpPlan.value);

      // ×©××œ ×¨×§ ××: ×™×© ×©× ×œ×§×˜×’×•×¨×™×”, ×”×©×ª× ×” ×”×¢×¨×š, ×•×”×¢×¨×š ×”×—×“×© ×”×•× ××¡×¤×¨ (×œ× ×¨×™×§)
      if (row.name && (old ?? '') !== (newVal ?? '') && newVal !== '') {
        askPropagatePlan(row.name, type, newVal);
      }

      row.plan = newVal;
      saveState(state);
      renderSummary();
      renderTables();
    });
    tdPlan.appendChild(inpPlan);

    // ×‘×¤×•×¢×œ
    const tdAct = document.createElement('td');
    const inpAct = document.createElement('input');
    inpAct.type = 'number'; inpAct.min = '0'; inpAct.step = '0.01';
    inpAct.value = row.actual !== '' ? row.actual : '';
    inpAct.addEventListener('change', () => {
      row.actual = parseNum(inpAct.value);
      saveState(state);
      renderSummary();
      renderTables();
    });
    tdAct.appendChild(inpAct);

    // ×”×¤×¨×© + ××—×•×– + ××—×™×§×”
    const tdDiff = document.createElement('td'); tdDiff.className = 'num';
    const tdPct  = document.createElement('td'); tdPct.className  = 'num';
    const tdDel  = document.createElement('td');
    const delBtn = document.createElement('button');
    delBtn.className = 'delete-btn';
    delBtn.textContent = 'ğŸ—‘ï¸';
    delBtn.addEventListener('click', () => {
      if (confirm('×œ××—×•×§ ×©×•×¨×” ×–×•?')) {
        const m = ensureMonth(currentYM);
        const list = (type === 'exp' ? m.expenses : m.incomes);
        list.splice(idx, 1);
        saveState(state);
        renderTables();
        renderSummary();
      }
    });
    tdDel.appendChild(delBtn);

    tr.appendChild(tdName);
    tr.appendChild(tdPlan);
    tr.appendChild(tdAct);
    tr.appendChild(tdDiff);
    tr.appendChild(tdPct);
    tr.appendChild(tdDel);

    // ×—×™×©×•×‘×™×
    const plan = row.plan === '' ? 0 : Number(row.plan);
    const act  = row.actual === '' ? 0 : Number(row.actual);
    const emptyBoth = (row.plan === '' && row.actual === '');
    const diff = act - plan;
    tdDiff.textContent = fmt(diff);

    if (!emptyBoth && plan > 0) {
      const pct = (act / plan) * 100;
      tdPct.textContent = pct.toFixed(0) + '%';
      if (pct < 80) tdPct.className = 'num pct-green';
      else if (pct < 100) tdPct.className = 'num pct-yellow';
      else tdPct.className = 'num pct-red';
    } else {
      tdPct.textContent = '';
      tdPct.className = 'num';
    }

    return tr;
  }

  function renderTables() {
    ensureMonth(currentYM);
    const m = state.months[currentYM];

    expTBody.innerHTML = '';
    m.expenses.forEach((row, idx) => {
      expTBody.appendChild(makeRow('exp', idx, row));
    });

    incTBody.innerHTML = '';
    m.incomes.forEach((row, idx) => {
      incTBody.appendChild(makeRow('inc', idx, row));
    });
enableLongPressDelete();
  }
function enableLongPressDelete() {
  const rows = document.querySelectorAll('table tbody tr');
  rows.forEach(row => {
    let pressTimer;

    // ×”×ª×—×œ×ª ×œ×—×™×¦×”
    row.addEventListener('touchstart', startPress);
    row.addEventListener('mousedown', startPress);

    // ×©×—×¨×•×¨ ×œ×—×™×¦×”
    row.addEventListener('touchend', cancelPress);
    row.addEventListener('mouseup', cancelPress);
    row.addEventListener('mouseleave', cancelPress);

    function startPress() {
      pressTimer = setTimeout(() => {
        const confirmDel = confirm('×œ××—×•×§ ××ª ×”×©×•×¨×” ×”×–×•?');
        if (confirmDel) {
          const btn = row.querySelector('.delete-btn');
          if (btn) btn.click();
        }
      }, 3000); // ×œ×—×™×¦×” ××¨×•×›×” â€“ 0.6 ×©× ×™×•×ª
    }

    function cancelPress() {
      clearTimeout(pressTimer);
    }
  });
}
  function sumList(list) {
    let total = 0;
    list.forEach(r => {
      const planEmpty = (r.plan === '' || r.plan === null || r.plan === undefined);
      const actEmpty  = (r.actual === '' || r.actual === null || r.actual === undefined);
      if (planEmpty && actEmpty) return;
      const act = r.actual === '' ? 0 : Number(r.actual);
      if (Number.isFinite(act)) total += act;
    });
    return total;
  }

  function sumPlanList(list) {
    let total = 0;
    list.forEach(r => {
      const planEmpty = (r.plan === '' || r.plan === null || r.plan === undefined);
      const actEmpty  = (r.actual === '' || r.actual === null || r.actual === undefined);
      if (planEmpty && actEmpty) return;
      const plan = r.plan === '' ? 0 : Number(r.plan);
      if (Number.isFinite(plan)) total += plan;
    });
    return total;
  }

  function renderSummary() {
    ensureMonth(currentYM);
    const m = state.months[currentYM];
    const income      = sumList(m.incomes);
    const incomePlan  = sumPlanList(m.incomes);
    const expense     = sumList(m.expenses);
    const expensePlan = sumPlanList(m.expenses);
    const net = income - expense;

    sumIncomeEl.textContent  = fmt(income);
    sumExpenseEl.textContent = fmt(expense);
    sumNetEl.textContent     = fmt(net);

    // Progress bars
    if (incomePlan > 0) {
      const incPct = Math.min((income / incomePlan) * 100, 100);
      incomeProgress.style.width = incPct + '%';
    } else {
      incomeProgress.style.width = '0%';
    }

    if (expensePlan > 0) {
      const expPct = Math.min((expense / expensePlan) * 100, 100);
      expenseProgress.style.width = expPct + '%';
    } else {
      expenseProgress.style.width = '0%';
    }

    // Badge
    if (net > 0) {
      savingBadge.textContent = '×—×™×¡×›×•×Ÿ ×—×™×•×‘×™';
      savingBadge.className = 'badge success';
    } else if (net < 0) {
      savingBadge.textContent = '×’×™×¨×¢×•×Ÿ';
      savingBadge.className = 'badge danger';
    } else {
      savingBadge.textContent = '××™×–×•×Ÿ';
      savingBadge.className = 'badge';
    }
  }

  /* =========================
     ADD ROWS
     ========================= */
  btnAddExp.addEventListener('click', () => {
    const m = ensureMonth(currentYM);
    m.expenses.push({ name: '', plan: '', actual: '' });
    saveState(state);
    renderTables();
  });

  btnAddInc.addEventListener('click', () => {
    const m = ensureMonth(currentYM);
    m.incomes.push({ name: '', plan: '', actual: '' });
    saveState(state);
    renderTables();
  });

  /* =========================
   SYNC NEW CATEGORIES TO ALL MONTHS
   ========================= */
function syncCategoriesToAllMonths() {
  const expDefaults = state.defaults.expenses || [];
  const incDefaults = state.defaults.incomes || [];

  for (const ym in state.months) {
    const month = state.months[ym];

    // ×”×•×¦××•×ª
    expDefaults.forEach(def => {
      if (!month.expenses.some(r => r.name === def.name)) {
        month.expenses.push({ name: def.name, plan: def.plan ?? '', actual: '' });
      }
    });

    // ×”×›× ×¡×•×ª
    incDefaults.forEach(def => {
      if (!month.incomes.some(r => r.name === def.name)) {
        month.incomes.push({ name: def.name, plan: def.plan ?? '', actual: '' });
      }
    });
  }

  saveState(state);
}
/* =========================
     PROPAGATE PLAN
     ========================= */
  function askPropagatePlan(name, type, newPlan) {
    if (!name) return;
    const ok = confirm(`ğŸ’¡ ×©×™× ×™×ª ××ª ×”×¦×¤×™ ×©×œ "${name}" ×œ-${fmt(newPlan)}.\n\n×¨×•×¦×” ×œ×¢×“×›×Ÿ ××ª ×”×¦×¤×™ ×’× ×‘×›×œ ×”×—×•×“×©×™× ×”×‘××™×?`);
    if (!ok) return;

    const fromDate = new Date(currentYM + '-01T00:00:00');
    let updated = 0;

    for (let i = 1; i <= 24; i++) {
      const d = new Date(fromDate);
      d.setMonth(d.getMonth() + i);
      const ym = ymStr(d);
      ensureMonth(ym);
      const list = (type === 'exp' ? state.months[ym].expenses : state.months[ym].incomes);
      const row = list.find(r => r.name === name);
      if (row) {
        row.plan = newPlan;
        updated++;
      }
    }
    saveState(state);
    alert(`âœ“ ×”×¦×¤×™ ×¢×•×“×›×Ÿ ×‘-${updated} ×—×•×“×©×™× ×§×“×™××”`);
  }

  /* =========================
     GOAL (×’×¨×£ ×™×¢×“ ×—×™×¡×›×•×Ÿ ×›×œ×œ×™)
     ========================= */
  function monthsBetweenInclusive(a, b) {
    if (!a || !b) return 0;
    const ad = new Date(a + '-01'); const bd = new Date(b + '-01');
    if (isNaN(ad) || isNaN(bd)) return 0;
    let c = 0, cur = new Date(ad);
    while (cur <= bd) {
      c++;
      cur.setMonth(cur.getMonth() + 1);
    }
    return Math.max(c, 0);
  }

  // ×©×™××™ ×œ×‘: ×”××œ×× ×˜×™× goalAmount/goalFrom/goalTo/goalMonthly/goalMsg/saveGoal ×œ× ×‘×”×›×¨×— ×§×™×™××™× ×‘-HTML ×”× ×•×›×—×™ ×©×œ×š.
  // ×œ×›×Ÿ ×× ×—× ×• ××’× ×™× ×¢×œ ×”×§×¨×™××•×ª ××œ×™×”×. ×× ×”× ××™× × ×§×™×™××™× â€” ×œ× × ×¨×©×•× ××™×¨×•×¢×™× ×•×œ× × ×¤×¢×™×œ ×©××™×¨×”.
  function saveGoalState() {
    if (!goalAmount || !goalFrom || !goalTo || !goalMonthly || !goalMsg) return;
    state.goal = state.goal || {};
    state.goal.amount = parseNum(goalAmount.value) || 0;
    state.goal.from   = goalFrom.value || state.goal.from;
    state.goal.to     = goalTo.value   || state.goal.to;
    saveState(state);
    const m = monthsBetweenInclusive(state.goal.from, state.goal.to);
    const per = (m > 0) ? (state.goal.amount / m) : 0;
    goalMonthly.textContent = fmt(per);
    goalMsg.textContent = '× ×©××¨ âœ“';
    setTimeout(() => goalMsg.textContent = '', 1500);
    renderGoalChart();
  }
  if (saveGoal) saveGoal.addEventListener('click', saveGoalState);

  let goalChart = null;
  function renderGoalChart() {
    const g = state.goal || {};
    if (!g.from || !g.to) return;
    const mCount = monthsBetweenInclusive(g.from, g.to);
    if (mCount <= 0) return;

    const labels = [];
    const planArr = [];
    const actualArr = [];
    const per = (g.amount || 0) / mCount;
    const start = new Date(g.from + '-01T00:00:00');

    for (let i = 0; i < mCount; i++) {
      const d = new Date(start); d.setMonth(d.getMonth() + i);
      const ym = ymStr(d);
      labels.push(ym);
      ensureMonth(ym);
      const m = state.months[ym];
      const income = sumList(m.incomes);
      const expense = sumList(m.expenses);
      const net = income - expense;
      actualArr.push(net);
      planArr.push(per);
    }

    const ctx = document.getElementById('goalBar')?.getContext('2d');
    if (!ctx) return;
    if (goalChart) { goalChart.destroy(); }
    goalChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: '×™×¢×“ ×—×•×“×©×™',
            data: planArr,
            backgroundColor: 'rgba(111, 66, 193, 0.5)',
            borderColor: 'rgba(111, 66, 193, 1)',
            borderWidth: 2
          },
          {
            label: '×—×™×¡×›×•×Ÿ ×‘×¤×•×¢×œ',
            data: actualArr,
            backgroundColor: 'rgba(0, 163, 137, 0.5)',
            borderColor: 'rgba(0, 163, 137, 1)',
            borderWidth: 2
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function (context) {
                return context.dataset.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function (value) { return fmt(value); }
            }
          }
        }
      }
    });
  }

  /* =========================
     REPORTS
     ========================= */
  let trendChart = null;

  function runSimpleForecast(toYM) {
    const nowYM = currentYM;
    const start = new Date(nowYM + '-01T00:00:00');
    const end   = new Date(toYM  + '-01T00:00:00');
    if (isNaN(start) || isNaN(end) || end < start) return { inc: 0, exp: 0, net: 0 };

    let inc = 0, exp = 0;
    const iter = new Date(start);
    while (iter <= end) {
      const ym = ymStr(iter);
      ensureMonth(ym);
      const m = state.months[ym];
      const incActualSum = sumList(m.incomes);
      const incPlanSum   = sumPlanList(m.incomes);
      const expActualSum = sumList(m.expenses);
      const expPlanSum   = sumPlanList(m.expenses);
      const hasIncActual = m.incomes.some(r => r.actual !== '' && r.actual > 0);
      const hasExpActual = m.expenses.some(r => r.actual !== '' && r.actual > 0);
      inc += (hasIncActual ? incActualSum : incPlanSum);
      exp += (hasExpActual ? expActualSum : expPlanSum);
      iter.setMonth(iter.getMonth() + 1);
    }
    return { inc, exp, net: inc - exp };
  }

  function renderForecastSummary() {
    const to = forecastTo?.value || ymStr(new Date(new Date().getFullYear(), 11, 1));
    const r = runSimpleForecast(to);
    const rows = forecastSummary?.querySelectorAll('tr');
    if (!rows || rows.length < 3) return;
    rows[0].children[1].textContent = fmt(r.inc);
    rows[1].children[1].textContent = fmt(r.exp);
    rows[2].children[1].textContent = fmt(r.net);
  }
  if (runForecast) runForecast.addEventListener('click', renderForecastSummary);

  function renderTrends() {
    const baseYear = new Date().getFullYear();
    const labels = [];
    const incLine = [];
    const expLine = [];
    const netLine = [];

    for (let m = 0; m < 12; m++) {
      const d = new Date(baseYear, m, 1);
      const ym = ymStr(d);
      labels.push(ym);
      ensureMonth(ym);
      const mm = state.months[ym];
      const inc = sumList(mm.incomes);
      const exp = sumList(mm.expenses);
      incLine.push(inc);
      expLine.push(exp);
      netLine.push(inc - exp);
    }

    const ctx = document.getElementById('trendLine')?.getContext('2d');
    if (!ctx) return;
    if (trendChart) trendChart.destroy();
    trendChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: '×”×›× ×¡×•×ª',
            data: incLine,
            borderColor: 'rgba(0, 163, 137, 1)',
            backgroundColor: 'rgba(0, 163, 137, 0.1)',
            tension: 0.4
          },
          {
            label: '×”×•×¦××•×ª',
            data: expLine,
            borderColor: 'rgba(204, 59, 59, 1)',
            backgroundColor: 'rgba(204, 59, 59, 0.1)',
            tension: 0.4
          },
          {
            label: '×—×™×¡×›×•×Ÿ × ×˜×•',
            data: netLine,
            borderColor: 'rgba(111, 66, 193, 1)',
            backgroundColor: 'rgba(111, 66, 193, 0.1)',
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          tooltip: {
            callbacks: {
              label: function (context) {
                return context.dataset.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { callback: function (value) { return fmt(value); } }
          }
        }
      }
    });
  }

  /* =========================
     EXPORT / IMPORT
     ========================= */
  function csvEscape(s) {
    if (s === null || s === undefined) return '';
    s = String(s).replace(/"/g, '""');
    return `"${s}"`;
  }

  function exportCSVAll() {
    const lines = [];
    lines.push(['×—×•×“×©','×¡×•×’','×©×','×¦×¤×™','×‘×¤×•×¢×œ'].map(csvEscape).join(','));
    Object.keys(state.months).sort().forEach(ym => {
      const m = state.months[ym];
      m.expenses.forEach(r => {
        lines.push([ym,'×”×•×¦××”', r.name, r.plan, r.actual].map(csvEscape).join(','));
      });
      m.incomes.forEach(r => {
        lines.push([ym,'×”×›× ×¡×”', r.name, r.plan, r.actual].map(csvEscape).join(','));
      });
    });
    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'finance-export.csv';
    a.click();
    URL.revokeObjectURL(url);
  }
  const exportCSVBtn = document.getElementById('exportCSV');
  if (exportCSVBtn) exportCSVBtn.addEventListener('click', exportCSVAll);

  const exportJSONBtn = document.getElementById('exportJSON');
  if (exportJSONBtn) exportJSONBtn.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
    const url  = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'finance-backup.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  const importInput = document.getElementById('importJSON');
  if (importInput) importInput.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const imported = JSON.parse(ev.target.result);
        if (confirm('×œ×©×—×–×¨ ×’×™×‘×•×™ ×–×”? ×”× ×ª×•× ×™× ×”× ×•×›×—×™×™× ×™×•×—×œ×¤×•.')) {
          state = imported;
          saveState(state);
          currentYM = ymStr(new Date());
          monthInput.value = currentYM;
          applyThemeFontFromState();
          renderTables();
          renderSummary();
          alert('×”×’×™×‘×•×™ ×©×•×—×–×¨ ×‘×”×¦×œ×—×”!');
        }
      } catch (err) {
        alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥');
        console.error(err);
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  });

  /* =========================
     SETTINGS PANEL
     ========================= */
  const btnOpenPanel = document.getElementById('btnOpenPanel');
  if (btnOpenPanel) btnOpenPanel.addEventListener('click', () => {
    renderManageTables();
    settingsPanel.classList.add('active');
    modalOverlay.classList.add('active');
  });

  if (btnClosePanel) btnClosePanel.addEventListener('click', () => {
    settingsPanel.classList.remove('active');
    modalOverlay.classList.remove('active');
  });

  if (modalOverlay) modalOverlay.addEventListener('click', () => {
    settingsPanel.classList.remove('active');
    modalOverlay.classList.remove('active');
  });

  document.querySelectorAll('input[name="theme"]').forEach(r => {
    r.addEventListener('change', () => { setTheme(r.value); });
  });
  document.querySelectorAll('input[name="font"]').forEach(r => {
    r.addEventListener('change', () => { setFont(r.value); });
  });

  function setTheme(val) {
    state.theme = val;
    document.body.classList.remove('theme-dark', 'theme-blue', 'theme-rose');
    if (val !== 'default') document.body.classList.add(val);
    saveState(state);
  }

  function setFont(val) {
    state.font = val;
    if (val === 'alef') {
      loadFont('Alef', 'https://fonts.googleapis.com/css2?family=Alef:wght@400;700&display=swap');
      document.documentElement.style.setProperty('--font', '"Alef", var(--font)');
    } else if (val === 'assistant') {
      loadFont('Assistant', 'https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap');
      document.documentElement.style.setProperty('--font', '"Assistant", var(--font)');
    } else {
      document.documentElement.style.setProperty('--font', 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans Hebrew", "Noto Sans"');
    }
    saveState(state);
  }

  function loadFont(name, href) {
    if (document.querySelector('link[data-font="' + name + '"]')) return;
    const l = document.createElement('link');
    l.rel = 'stylesheet'; l.href = href; l.setAttribute('data-font', name);
    document.head.appendChild(l);
  }

  if (resetAll) resetAll.addEventListener('click', () => {
    if (!confirm('×œ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™×? ×–×” ×™××—×§ ×”×›×œ ××”××›×©×™×¨ ×”×–×”.')) return;
    localStorage.removeItem(LS_KEY);
    state = ensureState();
    currentYM = ymStr(new Date());
    monthInput.value = currentYM;
    applyThemeFontFromState();
    renderTables(); renderSummary();
    settingsPanel.classList.remove('active');
    modalOverlay.classList.remove('active');
    alert('×”× ×ª×•× ×™× ××•×¤×¡×•.');
  });

  /* =========================
     MANAGE CATEGORIES
     ========================= */
  function renderManageTables() {
    if (!manageExpTBody || !manageIncTBody) return;

    // ×”×•×¦××•×ª
    manageExpTBody.innerHTML = '';
    state.defaults.expenses.forEach((r, idx) => {
      const tr = document.createElement('tr');
      const t1 = document.createElement('td');
      const t2 = document.createElement('td');
      const t3 = document.createElement('td');

      const n = document.createElement('input'); n.type = 'text'; n.value = r.name;
      n.addEventListener('input', () => { r.name = n.value; });

      const p = document.createElement('input'); p.type = 'number'; p.min = '0'; p.step = '0.01'; p.value = r.plan ?? '';
      p.addEventListener('change', () => { r.plan = parseNum(p.value); });

      const del = document.createElement('button'); del.textContent = 'ğŸ—‘ï¸'; del.className = 'delete-btn';
      del.addEventListener('click', () => {
        state.defaults.expenses.splice(idx, 1);
        renderManageTables();
      });

      t1.appendChild(n); t2.appendChild(p); t3.appendChild(del);
      tr.appendChild(t1); tr.appendChild(t2); tr.appendChild(t3);
      manageExpTBody.appendChild(tr);
    });

    // ×”×›× ×¡×•×ª
    manageIncTBody.innerHTML = '';
    state.defaults.incomes.forEach((r, idx) => {
      const tr = document.createElement('tr');
      const t1 = document.createElement('td');
      const t2 = document.createElement('td');
      const t3 = document.createElement('td');

      const n = document.createElement('input'); n.type = 'text'; n.value = r.name;
      n.addEventListener('input', () => { r.name = n.value; });

      const p = document.createElement('input'); p.type = 'number'; p.min = '0'; p.step = '0.01'; p.value = r.plan ?? '';
      p.addEventListener('change', () => { r.plan = parseNum(p.value); });

      const del = document.createElement('button'); del.textContent = 'ğŸ—‘ï¸'; del.className = 'delete-btn';
      del.addEventListener('click', () => {
        state.defaults.incomes.splice(idx, 1);
        renderManageTables();
      });

      t1.appendChild(n); t2.appendChild(p); t3.appendChild(del);
      tr.appendChild(t1); tr.appendChild(t2); tr.appendChild(t3);
      manageIncTBody.appendChild(tr);
    });
  }

  if (addExpCat) addExpCat.addEventListener('click', () => {
    state.defaults.expenses.push({ name: '', plan: '' });
    renderManageTables();
  });

  if (addIncCat) addIncCat.addEventListener('click', () => {
    state.defaults.incomes.push({ name: '', plan: '' });
    renderManageTables();
  });

â€if (saveCats) saveCats.addEventListener('click', () => {
â€  saveState(state);
â€  syncCategoriesToAllMonths(); // â† ×›××Ÿ ×”×§×¨×™××” ×œ×¤×•× ×§×¦×™×” ×”×—×“×©×”
â€  renderTables();
â€  settingsPanel.classList.remove('active');
â€  modalOverlay.classList.remove('active');
â€  alert('×”×§×˜×’×•×¨×™×•×ª × ×©××¨×• ×•×”×ª×•×•×¡×¤×• ×œ×›×œ ×”×—×•×“×©×™× ×‘×”×¦×œ×—×” âœ…');
});



  /* =========================
     INIT
     ========================= */
  function applyThemeFontFromState() {
    setTheme(state.theme || 'default');
    setFont(state.font || 'system');

    const themeRadio = document.querySelector(`input[name="theme"][value="${state.theme || 'default'}"]`);
    if (themeRadio) themeRadio.checked = true;

    const fontRadio = document.querySelector(`input[name="font"][value="${state.font || 'system'}"]`);
    if (fontRadio) fontRadio.checked = true;
  }

  function initGoalUI() {
    // UI ×™×©×Ÿ â€” × ×˜×¢×Ÿ ×¨×§ ×× ×”××œ×× ×˜×™× ×§×™×™××™×
    if (!goalAmount || !goalFrom || !goalTo || !goalMonthly) return;
    state.goal = state.goal || {
      amount: 0,
      from: ymStr(new Date()),
      to: ymStr(new Date())
    };
    goalAmount.value = state.goal.amount ?? 0;
    goalFrom.value   = state.goal.from;
    goalTo.value     = state.goal.to;
    const m = monthsBetweenInclusive(state.goal.from, state.goal.to);
    const per = (m > 0) ? (state.goal.amount / m) : 0;
    goalMonthly.textContent = fmt(per);
  }

  function initReportsUI() {
    if (!forecastTo) return;
    forecastTo.value = new Date(new Date().getFullYear(), 11, 1).toISOString().slice(0, 7);
  }

  function init() {
    applyThemeFontFromState();
    ensureMonth(currentYM);
    initMonthPicker();
    renderTables();
    renderSummary();
    initGoalUI();
    initReportsUI();
  }
/* =========================
   YEARLY OVERVIEW (×¦×¤×™ ××•×œ ×‘×™×¦×•×¢)
   ========================= */
function renderYearOverview() {
  const year = new Date().getFullYear();
  const month = new Date().getMonth() + 1; // ×”×—×•×“×© ×”× ×•×›×—×™
  const monthNameList = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
  const mName = monthNameList[month - 1];

  let incPlan = 0, incAct = 0, expPlan = 0, expAct = 0;
  const catTotals = {};

  // ××¢×‘×¨ ×¢×œ ×›×œ ×”×—×•×“×©×™× ×¢×“ ×”×—×•×“×© ×”× ×•×›×—×™
  for (let m = 0; m < month; m++) {
    const ym = `${year}-${String(m+1).padStart(2,'0')}`;
    if (!state.months[ym]) continue;
    const data = state.months[ym];
    data.incomes.forEach(r => {
      const p = parseNum(r.plan) || 0;
      const a = parseNum(r.actual) || 0;
      incPlan += p; incAct += a;
      if (!catTotals[r.name]) catTotals[r.name] = { type: 'income', plan: 0, act: 0 };
      catTotals[r.name].plan += p;
      catTotals[r.name].act += a;
    });
    data.expenses.forEach(r => {
      const p = parseNum(r.plan) || 0;
      const a = parseNum(r.actual) || 0;
      expPlan += p; expAct += a;
      if (!catTotals[r.name]) catTotals[r.name] = { type: 'expense', plan: 0, act: 0 };
      catTotals[r.name].plan += p;
      catTotals[r.name].act += a;
    });
  }

  const savPlan = incPlan - expPlan;
  const savAct  = incAct - expAct;

  // ×¢×“×›×•×Ÿ ×ª×™×‘×•×ª ×”×¢×œ
  document.getElementById('yearInc').textContent = fmt(incPlan);
  document.getElementById('yearExp').textContent = fmt(expPlan);
  document.getElementById('yearSav').textContent = fmt(savPlan);

  document.getElementById('yearIncText').textContent = `×¦×¤×™ ×¢×“ ${mName}: ${fmt(incPlan)} | ×‘×¤×•×¢×œ: ${fmt(incAct)}`;
  document.getElementById('yearExpText').textContent = `×¦×¤×™ ×¢×“ ${mName}: ${fmt(expPlan)} | ×‘×¤×•×¢×œ: ${fmt(expAct)}`;
  document.getElementById('yearSavText').textContent = `×¦×¤×™ ×¢×“ ${mName}: ${fmt(savPlan)} | ×‘×¤×•×¢×œ: ${fmt(savAct)}`;
  document.getElementById('yearSummaryLine').textContent =
    `×¢×“ ${mName} ×”×™×™×ª ×××•×¨×” ×œ×”×›× ×™×¡ ${fmt(incPlan)}, ×œ×”×•×¦×™× ${fmt(expPlan)}, ×•×œ×—×¡×•×š ${fmt(savPlan)}. ×‘×¤×•×¢×œ: ×”×›× ×¡×•×ª ${fmt(incAct)}, ×”×•×¦××•×ª ${fmt(expAct)}, ×—×™×¡×›×•×Ÿ ${fmt(savAct)}.`;

  const pctInc = incPlan > 0 ? (incAct / incPlan * 100) : 0;
  const pctExp = expPlan > 0 ? (expAct / expPlan * 100) : 0;
  const pctSav = savPlan !== 0 ? (savAct / savPlan * 100) : 0;

  document.getElementById('yearIncFill').style.width = Math.min(pctInc,100).toFixed(0)+'%';
  document.getElementById('yearExpFill').style.width = Math.min(pctExp,100).toFixed(0)+'%';
  document.getElementById('yearSavFill').style.width = Math.min(Math.abs(pctSav),100).toFixed(0)+'%';

  const tbody = document.querySelector('#yearCatTable tbody');
  tbody.innerHTML = '';

  Object.keys(catTotals)
    .filter(k => catTotals[k].type === 'expense')
    .forEach(k => {
      const r = catTotals[k];
      const plan = r.plan;
      const act = r.act;
      const varc = act - plan;
      const pct = plan > 0 ? (act / plan * 100) : 0;
      const badgeClass = pct <= 100 ? 'badge success' : 'badge danger';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${k}</strong></td>
        <td>${fmt(plan)}</td>
        <td>${fmt(act)}</td>
        <td>${(varc>=0?'+':'')+fmt(varc)}</td>
        <td class="num"><span class="${badgeClass}">${pct.toFixed(0)}%</span></td>
      `;
      tbody.appendChild(tr);
    });
}
  init();
/* =========================
     NAVIGATION (×¡×¨×’×œ ×ª×—×ª×•×Ÿ)
     ========================= */
  const navBtns = document.querySelectorAll('.nav-btn');
  navBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      navBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      tabs.forEach(t => t.classList.remove('active'));
      document.getElementById(btn.dataset.tab).classList.add('active');
if (btn.dataset.tab === 'tab-year') renderYearOverview();

      // ×”×¦×’×ª ×‘×—×™×¨×ª ×—×•×“×© ×¨×§ ×‘×˜××‘ ×—×•×“×© × ×•×›×—×™
      const monthPicker = document.querySelector('.month-picker');
      if (monthPicker) {
        monthPicker.style.display = (btn.dataset.tab === 'tab-month') ? 'flex' : 'none';
      }
    });
  });

</script>

<script>
/* =========================
   SAVINGS (× ×™×”×•×œ ×™×¢×“ ×—×™×¡×›×•×Ÿ)
   ========================= */
const defaultSavings = [
  "×§×¨×Ÿ ×”×©×ª×œ××•×ª ××’× ×•×¡",
  "×§×¨×Ÿ ×”×©×ª×œ××•×ª ××™×©×™×ª",
  "×§×•×¤×ª ×’××œ",
  "×¤× ×¡×™×”",
  "×¤×™×§×“×•×Ÿ ×—×•×“×©×™"
];

function createCard(name = "") {
  const div = document.createElement('div');
  div.className = "saving-card";
  div.innerHTML = `
    <div class="saving-header" onclick="toggleCard(this)">
      <h2 contenteditable="${name ? 'false' : 'true'}">${name || '×©× ×—×™×¡×›×•×Ÿ'}</h2>
      <div class="header-right">
        <span class="mini-total">0 â‚ª</span>
        <span class="toggle-icon">â–¼</span>
      </div>
    </div>
    <div class="saving-body">
      <div class="form-group">
        <label>ğŸ’µ ×¡×›×•× × ×•×›×—×™ (â‚ª):</label>
        <input type="number" class="current" oninput="updateMiniTotal(this); autoSave()">
      </div>
      <div class="form-group">
        <label>ğŸ“ˆ ×¡×•×’ ×—×™×¡×›×•×Ÿ:</label>
        <select class="type" onchange="toggleExtraFields(this)">
          <option value="static">×¡×˜×˜×™ - ×œ×œ× ×”×¤×§×“×•×ª</option>
          <option value="fixed">×§×‘×•×¢ - ×”×¤×§×“×” ×—×•×“×©×™×ª</option>
          <option value="variable">××©×ª× ×” - ×”×¤×§×“×” ×©× ×ª×™×ª</option>
        </select>
      </div>
      <div class="monthly-container form-group" style="display:none;">
        <label>ğŸ’³ ×”×¤×§×“×” ×—×•×“×©×™×ª (â‚ª):</label>
        <input type="number" class="monthlyDeposit" oninput="autoSave()">
      </div>
      <div class="yearly-container form-group" style="display:none;">
        <label>ğŸ“… ×”×¤×§×“×” ×©× ×ª×™×ª (â‚ª):</label>
        <input type="number" class="yearlyDeposit" oninput="autoSave()">
      </div>
      <div class="form-group">
        <label>ğŸ“Š ×ª×©×•××” ×©× ×ª×™×ª (%):</label>
        <input type="number" class="returnRate" placeholder="7" step="0.1" oninput="autoSave()">
      </div>
      <div class="forecast"></div>
      <div class="progress"><div class="progress-bar"></div></div>
      <button class="delete-btn" onclick="deleteCard(this)">ğŸ—‘ï¸ ××—×§</button>
    </div>`;
  return div;
}

function updateMiniTotal(input) {
  const card = input.closest('.saving-card');
  const val = parseFloat(input.value) || 0;
  card.querySelector('.mini-total').textContent = val.toLocaleString('he-IL') + ' â‚ª';
}

function toggleCard(header) {
  const body = header.nextElementSibling;
  body.classList.toggle("open");
}

function toggleExtraFields(select) {
  const card = select.closest('.saving-card');
  card.querySelector('.monthly-container').style.display = select.value === "fixed" ? "block" : "none";
  card.querySelector('.yearly-container').style.display = select.value === "variable" ? "block" : "none";
  autoSave();
}

function addSaving() {
  const container = document.getElementById('savingsContainer');
  const card = createCard();
  container.appendChild(card);
  card.querySelector('h2').focus();
  updateStats();
  autoSave();
}

function deleteCard(btn) {
  if (confirm("×œ××—×•×§ ×—×™×¡×›×•×Ÿ ×–×”?")) {
    btn.closest('.saving-card').remove();
    updateStats();
    autoSave();
    calculateForecast();
  }
}

/* =========================
   FORECAST CALCULATION
   ========================= */
function calculateForecast() {
  const cards = document.querySelectorAll('.saving-card');
  const targetDateEl = document.getElementById("targetDate");
  const targetDate = new Date(targetDateEl?.value);
  const today = new Date();

  if (isNaN(targetDate) || targetDate <= today) return;
  const months = (targetDate.getFullYear() - today.getFullYear()) * 12 + (targetDate.getMonth() - today.getMonth());
  let total = 0;

  cards.forEach(card => {
    const current = parseFloat(card.querySelector('.current').value) || 0;
    const type = card.querySelector('.type').value;
    const rate = parseFloat(card.querySelector('.returnRate').value) || 0;
    const monthlyRate = rate / 100 / 12;
    let future = current * Math.pow(1 + monthlyRate, months);

    if (type === "fixed") {
      const monthly = parseFloat(card.querySelector('.monthlyDeposit').value) || 0;
      future = current * Math.pow(1 + monthlyRate, months) + monthly * ((Math.pow(1 + monthlyRate, months) - 1) / monthlyRate || 0);
    }
    if (type === "variable") {
      const yearly = parseFloat(card.querySelector('.yearlyDeposit').value) || 0;
      const years = months / 12;
      future = current * Math.pow(1 + rate / 100, years) + yearly * years;
    }

    total += future;
    const progress = current > 0 ? Math.min((future / (current * 3)) * 100, 100) : 0;
    card.querySelector('.progress-bar').style.width = progress + "%";
    card.querySelector('.forecast').textContent = "×ª×—×–×™×ª: " + future.toLocaleString('he-IL') + " â‚ª";
  });

  const totalAmountEl = document.getElementById("totalAmount");
  if (totalAmountEl) totalAmountEl.textContent = total.toLocaleString('he-IL') + " â‚ª";
  updateStats();
  autoSave();
}

/* =========================
   STATS + AUTO-SAVE
   ========================= */
function updateStats() {
  const cards = document.querySelectorAll('.saving-card');
  let currentTotal = 0;
  cards.forEach(c => currentTotal += parseFloat(c.querySelector('.current').value) || 0);
  const totalEl = document.getElementById('currentTotal');
  const countEl = document.getElementById('savingsCount');
  if (totalEl) totalEl.textContent = currentTotal.toLocaleString('he-IL') + " â‚ª";
  if (countEl) countEl.textContent = cards.length;
}

function autoSave() {
  const data = [];
  document.querySelectorAll('.saving-card').forEach(card => {
    data.push({
      name: card.querySelector('h2').textContent,
      current: card.querySelector('.current').value,
      type: card.querySelector('.type').value,
      monthly: card.querySelector('.monthlyDeposit').value,
      yearly: card.querySelector('.yearlyDeposit').value,
      rate: card.querySelector('.returnRate').value
    });
  });
  localStorage.setItem('savingsData', JSON.stringify(data));
  const dateVal = document.getElementById('targetDate')?.value || '';
  localStorage.setItem('targetDate', dateVal);
}

/* =========================
   LOAD STATE ON START
   ========================= */
function loadState() {
  const data = JSON.parse(localStorage.getItem('savingsData') || "[]");
  const savedDate = localStorage.getItem('targetDate');
  const container = document.getElementById('savingsContainer');
  if (!container) return;

  container.innerHTML = '';
  if (savedDate) document.getElementById('targetDate').value = savedDate;

  if (data.length === 0) {
    defaultSavings.forEach(name => container.appendChild(createCard(name)));
  } else {
    data.forEach(item => {
      const card = createCard(item.name);
      card.querySelector('.current').value = item.current;
      card.querySelector('.type').value = item.type;
      toggleExtraFields(card.querySelector('.type'));
      card.querySelector('.monthlyDeposit').value = item.monthly;
      card.querySelector('.yearlyDeposit').value = item.yearly;
      card.querySelector('.returnRate').value = item.rate;
      updateMiniTotal(card.querySelector('.current'));
      container.appendChild(card);
    });
  }

  updateStats();
  if (savedDate) calculateForecast();
}

/* =========================
   DOMContentLoaded Listener
   ========================= */
window.addEventListener('load', loadState);

window.addEventListener("DOMContentLoaded", () => {
  const btnOpenPanel = document.getElementById('btnOpenPanel');
  const btnClosePanel = document.getElementById('btnClosePanel');
  const modalOverlay = document.getElementById('modalOverlay');
  const settingsPanel = document.getElementById('settingsPanel');

  if (!btnOpenPanel || !btnClosePanel || !modalOverlay || !settingsPanel) return;

  btnOpenPanel.addEventListener('click', () => {
    if (typeof renderManageTables === "function") renderManageTables();
    settingsPanel.classList.add('active');
    modalOverlay.classList.add('active');
  });

  btnClosePanel.addEventListener('click', () => {
    settingsPanel.classList.remove('active');
    modalOverlay.classList.remove('active');
  });

  modalOverlay.addEventListener('click', () => {
    settingsPanel.classList.remove('active');
    modalOverlay.classList.remove('active');
  });
});
</script>

</body>
</html>
